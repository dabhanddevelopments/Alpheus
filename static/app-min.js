Ext.Loader.setPath("Ext.ux","http://dabhand.net:8080/static/ext-4.2.1/examples/ux");Ext.require(["Ext.ux.RowExpander"]);Ext.require(["Ext.container.Viewport","Ext.layout.container.Border","Ext.tab.Panel","Ext.tree.*","Ext.data.*","Ext.menu.*","Ext.window.MessageBox","Ext.grid.*",]);function investmentNAV(a,j){var b=$("#data").data(j);if($("#data").data("date")=="undefined"){var d=new Date()}else{var d=$("#data").data("date")}win=Ext.getCmp(a);title="asdf";console.log("asdfasdf");console.log(win);var h={"ad-hoc":"Ad-hoc",cash:"Cash",loan:"Loans",pe:"PE Commitments",hsbc:"HSBC",cs:"Credit Suisse"};var g=[];var k=[];var e=[];var f=0;$.each(h,function(m,l){if(m=="hsbc"||m=="cs"){var n="fund__custodian"}else{var n="asset_class"}g.push($.ajax({url:"/api/holding-history/?column_border_y=ytd&column_width=100,180&data_type=year&date=value_date&extra_fields=ytd&holding__"+n+"__key="+m+"&holding__"+j+"="+b+"&title=holding__name&total=true&value=performance&value_date__year="+moment(d).format("YYYY"),ajaxI:m,success:function(o){x=this.ajaxI;$.each(o.rows,function(q,p){p.group=h[x];p.group_order=f;f++;k.push(p)});e=o.columns}}))});$.when.apply($,g).then(function(){console.log("grid_data");console.log(k);e.push({dataIndex:"group",collapsible:false});console.log(e);fields=[];for(f=0;f<e.length;f++){fields[f]={};if(f==0||e[f].dataIndex=="group"){fields[f]["type"]="string"}else{fields[f]["type"]="float"}if(typeof e[f].dataIndex!="undefined"){fields[f]["name"]=e[f].dataIndex}}if(typeof e[1]["summaryType"]!="undefined"){e[0]["summaryRenderer"]=function(o,q,p){return"Total"}}$.each(k,function(o,p){$.each(p,function(q,r){if(r.toString().indexOf(".")!=-1){k[o][q]=parseFloat(r.toString())}})});var n=Ext.getCmp("fundperf"+a);if(typeof n!="undefined"){n.destroy()}var l=Ext.create("Ext.data.Store",{data:k,groupField:"group",fields:fields,});var m=Ext.create("Ext.grid.Panel",{height:950,id:"fundperf"+a,renderTo:a,store:l,border:false,header:false,forceFit:true,features:[{ftype:"groupingsummary",groupHeaderTpl:"{name}",hideGroupedHeader:true,}],columns:e,});return widgetWindow(data.window.id,page,data.window.name+"asdf",data.window.size_x,data.window.size_y,data.id,window_id)})}function displayInnerGrid(f,e,g,d,a){fields=[];for(i=0;i<e.columns.length;i++){fields[i]=e.columns[i].dataIndex}if(typeof d=="undefined"){d:false}if(typeof a=="undefined"){a:100}var h=Ext.create("Ext.data.Store",{fields:fields,data:e.rows,proxy:{type:"memory",reader:{type:"json",root:"objects"}}});var b=Ext.create("Ext.grid.Panel",{store:h,selModel:{selType:"cellmodel"},columns:e.columns,header:false,autoFit:true,width:1000,height:a,iconCls:"icon-grid",hideHeaders:d,renderTo:"innergrid-"+f.id+"-"+g,});b.getEl().swallowEvent(["mousedown","mouseup","click","contextmenu","mouseover","mouseout","dblclick","mousemove"])}function zoomGraph(k,h){var m=h.qs.replace("&value_date__month=2,4,6,8,10,12","");var b=new Date(k.min);var g=new Date(k.max);var j=b.getFullYear()+"-"+(b.getMonth()+1)+"-"+b.getDate();var d=g.getFullYear()+"-"+(g.getMonth()+1)+"-"+g.getDate();var f="&value_date__gte="+j+"&value_date__lte="+d;range=(k.max/1000)-(k.min/1000);range=Math.round(range);var a="&date_type=m";if(range>300000000){a+="&value_date__month=2,4,6,8,10,12"}else{if(range>=240000000){a+="&value_date__month=2,4,6,8,10,12"}else{if(range>=120000000){a+="&value_date__week_day=3,5"}else{if(range>=60000000){a+="&value_date__week_day=2,4,6"}else{a+=""}}}}var l=$("#"+h.div).highcharts();l.showLoading("Loading data from server...");$.getJSON(h.url+m+f+a,function(e){console.log(e);l.series[0].setData(e.objects[0].data);l.hideLoading()})}function zoomLineBarGraph(k){console.log(k);holding=$("#data").data("holding");var a=$("#data").data("linebar-div");var m="?holding="+holding+"&data_type=graph&y1=price_of_unit&date=value_date&date_type=d";var d=new Date(k.min);var h=new Date(k.max);var j=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();var f=h.getFullYear()+"-"+(h.getMonth()+1)+"-"+h.getDate();var g="&value_date__gte="+j+"&value_date__lte="+f;range=(k.max/1000)-(k.min/1000);range=Math.round(range);if(range>31557600){var b="&value_date__month=2,4,6,8,10,12&value_date__day=1"}else{if(range>=31535000){var b="&value_date__week_day=4"}else{if(range>=15535000){var b="&value_date__week_day=3,5"}else{if(range>=7700000){var b="&value_date__week_day=2,4,6"}else{var b=""}}}}var l=$("#"+a).highcharts();l.showLoading("Loading data from server...");$.getJSON("/api/holding-history/"+m+g+b,function(n){l.series[0].setData(n);l.hideLoading();var e="?holding="+holding+"&data_type=graph&y1=no_of_units&date=trade_date";$.getJSON("/api/fund/"+e+g+b,function(o){l.series[1].setData(o);l.hideLoading()})})}function lineBarChart(b){b.url="/api/holding-history/";b.qs="?value_date__month=2,4,6,8,10,12&value_date__day=1&data_type=graph&date=value_date&y1=price_of_unit&date_type=m&holding="+b.holding;$("#data").data("holding",b.holding);var d=$("#data").data("linebar-div");var a=$("#"+d).highcharts();if(typeof a!="undefined"){a.destroy()}$.getJSON(b.url+b.qs,function(e){e=e.data;b.url="/api/trade/";qs="?data_type=graph&date=trade_date&y1=no_of_units&holding="+b.holding;$.getJSON(b.url+qs,function(h){h=h.data;console.log(e);var f={chart:{renderTo:d,marginTop:5,marginBottom:50,marginRight:50,spacingBottom:50,spacingRight:50,},navigator:{enabled:true,adaptToUpdatedData:false,series:{data:e}},scrollbar:{enabled:false,},title:{text:false,},xAxis:[{gridLineWidth:1,type:"datetime",labels:{rotation:-45,align:"right",style:{fontSize:"13px",fontFamily:"Verdana, sans-serif"}},events:{afterSetExtremes:zoomLineBarGraph},minRange:3600*1000},{}],yAxis:[{height:180,lineWidth:3,offset:0,gridLineWidth:1,title:{text:"Price",margin:5,}},{top:225,lineWidth:3,gridLineWidth:1,offset:0,height:75,title:{text:"Volume",}},],legend:{enabled:true,verticalAlign:"top",y:-10,},rangeSelector:{enabled:true,buttons:[{type:"month",count:1,text:"1m"},{type:"month",count:3,text:"3m"},{type:"month",count:6,text:"6m"},{type:"year",count:1,text:"1y"},{type:"all",text:"All"}],inputEnabled:false,selected:4},series:[{yAxis:0,name:"Price by time",stack:0,data:e,tooltip:{valueDecimals:2},marker:{enabled:false}},{name:"Volume",yAxis:1,stack:0,data:h,tooltip:{valueDecimals:2},lineWidth:3,marker:{enabled:false},pointWidth:5,type:"column",},]};var g=new Highcharts.Chart(f)})})}function destroyInnerGrid(a,b){var d=document.getElementById("innergrid-"+b+"-"+a.get("id"));var e=d.firstChild;while(e){e.parentNode.removeChild(e);e=e.nextSibling}}function refreshHoldPerfBar(e,f,b,d,j,g){if(e=="w45"||e=="w33"){var l="client";var o=7}else{var l="fund";var o=6}if(typeof j=="undefined"){j="performance"}if(typeof g=="undefined"){g="weight"}var a=$("#data").data("barchart-"+e);$("#data").data("date",f);var n=f;if(typeof d!="undefined"&&d==true){n=moment(f).format("MMM YYYY")}var m=$("#data").data(l+"_name")+" / "+n+" / Holding Performance";var h=a.slice(0,a.indexOf("_widget"));win=Ext.getCmp(h);win.setTitle(m);var k=$("#"+a).highcharts();k.destroy();widget={key:"holding-history",qs:"?value_date="+f+"&holding__"+l+"="+b+"&legend=false&y1="+j+"&order_by="+g+"&data_type=graph&date_type=m&title=holding__name",type:"bar_chart",size_x:o,size_y:3,params:{},window:{key:e,}};obj={};obj[l]=b;return createWidget(obj,widget,a)}function holdingTab(d,b){$("#data").data("holding",d);$("#data").data("holding_name",b);parent_div="page111-holdings"+d;$('<div id="'+parent_div+'"></div>').appendTo("body");var a=Ext.getCmp("panel-tab");tabs={112:"Performance",113:"Stats",114:"NAV",115:"Summary",};items=[];$.each(tabs,function(e,g){var f=e+"-holdings"+d;$("#data").data("grid"+f,"");$('<div id="'+f+'" class="gridster"></div>').appendTo("body");$('<div id="page'+f+'" class="gridster"></div>').appendTo("body");items.push({title:g,itemId:e,contentEl:"page"+f,autoScroll:true,listeners:{activate:function(h){obj={};obj.page=f,initGrid(obj)}},})});parent_id="page111-"+d;a.add({xtype:"tabpanel",id:parent_id,title:b,contentEl:parent_div,closable:true,autoScroll:true,activeTab:0,items:items});a.setActiveTab(parent_id)}Ext.onReady(function(){window.holdingTab=holdingTab;window.initGrid=v;window.createWidget=L;window.investmentNAV=investmentNAV;function w(S){graphs={1:[{ann_return1:"Returns one ann"},{ann_volatility1:"Volatility one ann"},{alpha1:"Alpha one ann"},{beta1:"Beta one ann"},{sharpe_ratio1:"Sharpe one ann"},{correlation1:"Correlation one ann"},],2:[{ann_return3:"Returns three ann"},{ann_volatility3:"Volatility three ann"},{alpha3:"Alpha three ann"},{beta3:"Beta three ann"},{sharpe_ratio3:"Sharpe three ann"},{correlation3:"Correlation three ann"},],3:[{ann_return5:"Returns five ann"},{ann_volatility5:"Volatility five ann"},{alpha5:"Alpha five ann"},{beta5:"Beta five ann"},{sharpe_ratio5:"Sharpe five ann"},{correlation5:"Correlation five ann"},]};var W=$("#data").data(S);items=[];for(var V in graphs){children=[];for(var R in graphs[V]){key=Object.keys(graphs[V][R])[0];var U="summary2-bar-"+key;var T="summary2-line-"+key;$('<div id="'+U+'"></div>').appendTo("body");$('<div id="'+T+'"></div>').appendTo("body");win_widget2={};win_widget2.url="/api/"+S+"-history/";win_widget2.qs="?"+S+"="+W+"&y1="+key+"&data_type=graph&date=value_date&value_date__month=2,4,6,8,10,12";win_widget2.size_y=1.9;win_widget2.size_x=3;win_widget2.div=U;win_widget2.params={};win_widget2.params.type="column";win_widget2.params.legend="false";win_widget2.params.scrollbar="false";win_widget2.params.navigator="true";win_widget2.params.zoom="true";win_widget2.params.rangeSelector="true";win_widget2.params.title="false";win_widget2.params.yAxisTitle=graphs[V][R][key];win_widget2.params.date_type="month";m("",win_widget2,U);children.push({xtype:"tabpanel",border:1,width:(120*win_widget2.size_x)+(10*win_widget2.size_x)+(10*(win_widget2.size_x-1))-20,height:(120*win_widget2.size_y)+(10*win_widget2.size_y)+(10*(win_widget2.size_y-1))+20,items:[{xtype:"panel",title:"Bar",contentEl:U,id:U},{xtype:"panel",title:"Line",contentEl:T,id:T}],listeners:{tabchange:function(Y,X){win_widget2.params.type="line";m("",win_widget2,X.id)}}})}parent={xtype:"container",layout:"hbox",items:children,};items.push(parent)}Ext.onReady(function(){var X=new Ext.Window({renderTo:Ext.getBody(),items:items,listeners:{close:function(Z,Y){$.each(graphs,function(aa,ab){$.each(ab,function(ac,ad){ac=Object.keys(ad)[0];G("summary2-bar-"+ac);G("summary2-line-"+ac)})})}}});X.toggleMaximize();X.show()})}function G(S){if(typeof $("#"+S).highcharts()!="undefined"){var R=$("#"+S).highcharts();R.destroy()}}$('<div id="data"></div>').appendTo("body");function N(S){var T=S.page;var R=$("#data").data("page");for(i=0;i<R.length;i++){if(typeof R[i].children!="undefined"){page_id=R[i].children[0].id}else{page_id=R[i].id}if(page_id==T){if(R[i].children!==undefined){D(b());n(R[i]);S.page=page_id}else{D(e());$("#data").data("grid"+T,"");$('<div id="page'+T+'"></div>').appendTo("#menu")}v(S)}}}function n(S){var R=Ext.getCmp("panel-tab");R.removeAll();for(x=0;x<S.children.length;x++){id=S.children[x].id;$('<div id="page'+id+'" class="gridster"></div>').appendTo("body");$("#data").data("grid"+id,"");R.add({title:S.children[x].title,id:id,contentEl:"page"+id,autoScroll:true,listeners:{activate:function(T){obj={};obj.page=T.id;v(obj)}},})}R.setActiveTab(0)}function D(S){var U=$("#data").data("active-panel");$("#data").data("year",false);var R=Ext.getCmp("viewport");try{R.remove(U,true)}catch(T){}$('<div id="menu" class="gridster"></div>').appendTo("body");try{R.add(S)}catch(T){}R.doLayout();$("#data").data("active-panel",S.id)}function v(U){var S=U.page;$("#data").data("page_id",S);if($("#data").data("grid"+S)!==undefined&&$("#data").data("grid"+S)!==""){return}U.grid=$("#page"+S).gridster({widget_margins:[10,10],widget_base_dimensions:[120,120],max_size_x:10,max_size_y:10,draggable:{stop:function(V,W){j(JSON.stringify(U.grid.serialize()))}},serialize_params:function(W,V){return{id:V.el[0].id,col:V.col,row:V.row,size_y:V.size_y,size_x:V.size_x,pagewindow:W.context.attributes.pagewindow.value,}}}).data("gridster");U.grid.disable();$("#data").data("grid"+S,U.grid);try{var R=S.split("-")[0]}catch(T){var R=S}$.ajax({type:"GET",url:"/api/pagewindow/?page="+R,success:function(V){$("#data").data("grid_data"+S,V);for(i=0;i<V.length;i++){K(V[i],i,U)}}})}function K(U,W,T,V){if(typeof T.fund=="undefined"){T.fund=$("#data").data("fund")}function ac(ai,aj,ah){if(typeof Ext.getCmp("grid"+ai)=="undefined"){Z=[];for(W=0;W<aj.columns.length;W++){Z[W]=aj.columns[W].dataIndex}Ext.create("Ext.data.Store",{storeId:"store"+ai,fields:Z,data:aj,proxy:{type:"memory",reader:{type:"json",root:"rows"}},});return Ext.create("Ext.grid.Panel",{store:Ext.data.StoreManager.lookup("store"+ai),columns:aj.columns,id:"grid"+ai,border:false,flex:ah,forceFit:true,layout:"fit",margin:"0 0 20 0",})}}function S(ai){var ah=ai.split("-");if(typeof ah[1]=="undefined"){ah[1]=1;ah[0]=ai;ai=ai+"-1"}$.getJSON("/api/fund-subredtable/?fund="+T.fund+"&year="+ah[0]+"&month="+ah[1]+"&column_width=80,80",function(ak){tab=Ext.getCmp(ai);var al=ac(ai,ak,0);tab.add(al);var aj="&fields=client__first_name,client__last_name,sub_red,trade_date,no_of_units,euro_nav,percent_released";$.getJSON("/api/subscription-redemption/?fund="+T.fund+"&year="+ah[0]+"&month="+ah[1]+"&column_width=100,100"+aj,function(an){tab=Ext.getCmp(ai);var am=ac("client"+ai,an,1);tab.add(am)})})}function af(ai,ah){$.getJSON("/api/fund-grossasset1/?fund="+T.fund+"&year="+ah+"&column_width=160,85",function(ak){var aj=a(ak,U.window);ai.insert(0,aj);ai.doLayout()})}function X(ah){var aj=ah.toString().slice(-1);if($.isNumeric(aj)==false){if(ah=="ann_return"){ah="si"}else{if(ah!="si"){ah=ah+"1"}}}var al="";if(U.window.key=="w18"){var ak="fund"}else{if(U.window.key=="w38"){var ak="client"}else{if(U.window.key=="w58"){var ak="fund";var al="holding__"}else{var ak="holding"}}}var ai=$("#data").data(ak);if(typeof Ext.getCmp("grid"+ah)=="undefined"){tab=Ext.getCmp(ah);$.getJSON("/api/"+ak+"-history/?"+al+ak+"="+ai+"&value="+ah+"&column_width=55,60&data_type=year&date=value_date&extra_fields=ytd&date_type=m",function(ap){var am="inner-tab"+ah;$('<div id="'+am+'-bar"></div>').appendTo("#"+Y);$('<div id="'+am+'-line"></div>').appendTo("#"+Y);$('<div id="'+am+'-line-table"></div>').appendTo("#"+Y);widget={};widget.url="";widget.qs="/api/"+ak+"-performance-benchmark/?fields="+ah+"&"+ak+"="+ai;widget.size_y=5;widget.size_x=6;widget.params={title:"",date_type:"month",navigator:"true",rangeSelector:"true",};var an=$("#"+am+"-bar").highcharts();if(typeof an=="undefined"){widget.params.type="line";m("",widget,am+"-line")}var ao=new Ext.TabPanel({id:"inner-tab-id"+ah,border:false,height:750,activeTab:0,items:[{title:"Line Graph",id:"line"+ah,contentEl:am+"-line",},{title:"Bar Chart",id:"bar"+ah,contentEl:am+"-bar",},{title:"Data Table",id:"line-table"+ah,contentEl:am+"-line-table",},],listeners:{tabchange:function(au,ar){if(ar.id=="bar"+ah){div2=am+"-bar";var aq=$("#"+div2).highcharts();if(typeof aq=="undefined"){widget.params.type="column";widget.size_y=5;m("",widget,div2)}}if(ar.id=="line-table"+ah){var at=ac(ah,ap);ar.add(at);div2=am+"-line-table";var aq=$("#"+div2).highcharts();if(typeof aq=="undefined"){widget.params.type="line";widget.size_y=3;m("",widget,div2)}}}}});tab.add(ao)})}}var ab=T.page;var R=$("#data").data("grid"+ab);var aa='<div id="'+ab+"_"+U.window.id+'" pagewindow="'+U.id+'" class="layout_block"></div>';R.add_widget(aa,U.window.size_x,U.window.size_y,U.col,U.row);var ag="page_"+ab+"_"+U.window.id;$('<div id="'+ag+'"></div>').appendTo("body");if(U.window.key=="w15"){var Z="name,fund_type__name,manager__first_name,performance_fee,manager__last_name,description,custodian__name,custodian__contact_name,custodian__contact_number,custodian_management_fee,custodian_performance_fee,administrator__contact_name,administrator__contact_number,administrator__name,administrator_fee,auditor_fee,auditor__name,auditor__contact_number,auditor__contact_name,subscription_frequency,redemption_frequency,management_fee";$.getJSON("/api/fund/"+T.fund+"/?fields="+Z,function(ah){d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag);html='<div> <table width="100%" class="html_table"><tr><td>Fund Name</td><td>'+ah.name+"</td></tr><tr><td>Fund Type</td><td>"+ah.fund_type__name+"</td></tr><tr><td>Fund Manager</td><td>"+ah.manager__first_name+ah.manager__last_name+"</td></tr><tr><td>Description</td><td>"+ah.description+"<d></tr><tr><td>Custodian</td><td>"+ah.custodian__name+"</td><td>"+ah.custodian__contact_name+"</td><td>"+ah.custodian__contact_number+"</td><td>Managment Fee</td><td>"+ah.custodian_management_fee+"</td><td>Performance Fee</td><td>"+ah.custodian_performance_fee+"</td></tr><tr><td>Administrator</td><td>"+ah.administrator__name+"</td><td>"+ah.administrator__contact_name+"</td><td>"+ah.administrator__contact_number+"</td><td>Administrator Fee</td><td>"+ah.administrator_fee+"</td></tr><tr><td>Auditor</td><td>"+ah.auditor__name+"</td><td>"+ah.auditor__contact_name+"</td><td>"+ah.auditor__contact_number+"</td><td>Auditor Fee</td><td>"+ah.auditor_fee+"</td></tr><tr><td>Subscription Terms</td><td>"+ah.subscription_frequency+"</td></tr><tr><td>Redemption Terms</td><td>"+ah.redemption_frequency+"</td></tr><tr><td>Management Fees</td><td>"+ah.management_fee+"</td></tr><tr><td>Performance Fees</td><td>"+ah.performance_fee+"</td></tr>";$.getJSON("/api/benchmark/?fields=name&fund="+T.fund,function(ai){for(W=0;W<ai.rows.length;W++){if(W==0){var aj="Benchmarks"}else{var aj=""}html+="<tr><td>"+aj+"</td><td>"+ai.rows[W].name+"</td></tr>"}html+="</table> </div>";$(html).appendTo("#"+ag)})});return}if(U.window.key=="w47"){var Z="first_name,last_name,description,custodian__name,custodian__contact_name,manager__first_name,manager__last_name";$.getJSON("/api/client/"+T.client+"/?fields="+Z,function(ah){d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag);html='<div> <table width="100%" class="html_table"><tr><td>Client Name</td><td>'+ah.last_name+", "+ah.first_name+"</td></tr><tr><td>Client Manager</td><td>"+ah.manager__first_name+ah.manager__last_name+"</td></tr><tr><td>Description</td><td>"+ah.description+"<d></tr><tr><td>Custodian</td><td>"+ah.custodian__name+"</td><td>"+ah.custodian__contact_name+"</td></tr>"+$.getJSON("/api/benchmark/?fields=name&client="+T.client,function(ai){for(W=0;W<ai.rows.length;W++){if(W==0){var aj="Benchmarks"}else{var aj=""}html+="<tr><td>"+aj+"</td><td>"+ai.rows[W].name+"</td></tr>"}html+="</table> </div>";$(html).appendTo("#"+ag)})});return}if(U.window.key=="w18"||U.window.key=="w80"||U.window.key=="w38"||U.window.key=="w58"){parents=[{id:"ann_return",title:"Returns"},{id:"ann_volatility",title:"Volatility"},{id:"sharpe_ratio",title:"Sharpe"},{id:"alpha",title:"Alpha"},{id:"beta",title:"Beta"},{id:"correlation",title:"Correlation"},];children=[{id:"1",title:"1 Year Rolling Annualised"},{id:"3",title:"3 Years Rolling Annualised"},{id:"5",title:"5 Years Rolling Annualised"},];items=[];for(W=0;W<parents.length;W++){childItems=[];if(parents[W].id=="ann_return"){childItems.push({id:"si",title:"Since Inception"})}for(x=0;x<children.length;x++){childItems.push({id:parents[W].id+children[x].id,title:children[x].title,layout:"fit",})}items.push({xtype:"tabpanel",title:parents[W].title,id:U.window.key+"-parent-"+parents[W].id,activeTab:0,items:childItems,listeners:{tabchange:function(ai,ah){X(ah.id)}}})}var Y="tab-"+U.window.key+"-"+ag;$('<div id="'+Y+'"></div>').appendTo("#"+ag);if(U.window.key=="w80"){var ad="holding"}else{var ad="fund"}var ae=new Ext.TabPanel({renderTo:Y,id:U.window.key+"-tabs",activeTab:0,items:items,layout:"fit",listeners:{beforetabchange:function(ai,ah){if(ah.id=="summary-tab"){w(ad);return false}var aj=ah.id.split("-");X(aj[2])}}});X("si");ae.add({title:"Summary",id:"summary-tab",});return d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag)}else{if(U.window.key=="w23"){this_year=new Date().getFullYear();parents=[];items=[];children=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];for(W=this_year;W>2002;W--){parents.push(W)}for(W=0;W<parents.length;W++){childItems=[];for(x=0;x<children.length;x++){childItems.push({id:parents[W]+"-"+(1+x),title:children[x],layout:{type:"vbox",align:"stretch"}})}items.push({xtype:"tabpanel",title:parents[W],id:"w23-parent-"+parents[W],activeTab:0,items:childItems,listeners:{tabchange:function(ai,ah){S(ah.id)}}})}var Y="tab-"+U.window.key+"-"+ag;$('<div id="'+Y+'"></div>').appendTo("#"+ag);var ae=new Ext.TabPanel({renderTo:Y,id:"w23-tabs",activeTab:0,items:items,layout:"fit",listeners:{tabchange:function(ai,ah){var aj=ah.id.split("-");S(aj[2])}}});S(this_year+"-1");return d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag)}}if(U.window.key=="w13"){this_year=new Date().getFullYear();parents=[];items=[];for(W=this_year;W>2002;W--){parents.push(W)}for(W=0;W<parents.length;W++){items.push({title:parents[W],id:"w13-year-"+parents[W],})}var Y="tab-"+U.window.key+"-"+ag;$('<div id="'+Y+'"></div>').appendTo("#"+ag);var ae=new Ext.TabPanel({renderTo:Y,id:"w13-tabs",activeTab:0,items:items,layout:"fit",listeners:{tabchange:function(ai,ah){var aj=ah.id.split("-");af(ah,aj[2])}}});tab=Ext.getCmp("w13-year-"+this_year);af(tab,this_year);return d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag)}var ag="page_"+ab+"_"+U.window.id;$('<div id="'+ag+'"></div>').appendTo("body");if(U.window.key=="w55"){investmentNAV(ag,"fund");return d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag)}else{if(U.window.key=="w46"){investmentNAV(ag,"client")}else{if(U.window.key=="w68"){investmentNAV(ag,"fund")}}}$.ajax({type:"GET",url:"/api/widgets/?window="+U.window.id+"&enabled=1",ajaxI:W,success:function(ak){I=this.ajaxI;var al=U.window.layout+"box";var ai=[];for(x=0;x<ak.length;x++){var aj="page_"+ab+"_win_"+U.window.id+"_widget_"+ak[x].id;$('<div id="'+aj+'"></div>').appendTo("#"+ag);var ah=L(T,ak[x],aj);ai[x]={contentEl:aj,height:(120*ak[x].size_y)+(10*ak[x].size_y)+(10*(ak[x].size_y-1)),width:(120*ak[x].size_x)+(10*ak[x].size_x)+(10*(ak[x].size_x-1)),border:false,autoScroll:true,}}Ext.create("Ext.container.Container",{renderTo:ag,autoFit:true,header:true,layout:al,items:ai,});d(U.window.id,ab,U.window.name,U.window.size_x,U.window.size_y,U.id,ag)}})}function d(V,X,Y,T,R,U,W){if(typeof $("#data").data("date")!=="undefined"){var S=$("#data").data("date")}else{var S=new Date()}Y=Y.replace("YEAR",moment(S).format("YYYY"));Y=Y.replace("MONTH",moment(S).format("MMM"));if(typeof $("#data").data("fund_name")!="undefined"){Y=Y.replace("FUND_NAME",$("#data").data("fund_name"))}if(typeof $("#data").data("client_name")!="undefined"){Y=Y.replace("CLIENT_NAME",$("#data").data("client_name"))}if(typeof $("#data").data("holding_name")!="undefined"){Y=Y.replace("HOLDING_NAME",$("#data").data("holding_name"))}Ext.create("Ext.window.Window",{title:Y,height:(120*R)+(10*R)+(10*(R-1))-10,width:(120*T)+(10*T)+(10*(T-1))-10,layout:"auto",floatable:false,draggable:false,closable:false,contentEl:W,x:0,y:0,renderTo:X+"_"+V,id:"page_"+X+"_win_"+V,tools:[{type:"close",handler:function(ac,ab,aa,Z){Ext.Msg.show({title:"Remove Widget?",msg:"You want to remove the widget from this page?",buttons:Ext.Msg.OKCANCEL,icon:Ext.Msg.CONFIRM,fn:function(ae){if(ae=="ok"){var ad=$("#data").data("grid"+X);ad.remove_widget($("#"+X+"_"+V));J(U)}}})}}],}).show()}function J(R){$.ajax({type:"DELETE",url:"/api/pagewindow/"+R+"/",success:function(){},error:function(S){},})}function L(V,U,X,T){if(typeof V.client=="undefined"){V.client=$("#data").data("client")}if(typeof V.fund=="undefined"){V.fund=$("#data").data("fund")}V.id=V.fund;V.holding__fund=V.fund;if(typeof $("#data").data("holding")!="undefined"){V.holding=$("#data").data("holding");U.holding=V.holding}if(typeof T!="undefined"){$.each(T,function(Y,Z){U.qs=U.qs.replace(Y.toUpperCase(),Z)})}if(typeof U.params!="undefined"){$.each(U.params,function(Y,Z){U.qs=U.qs.replace(Y.toUpperCase(),Z)})}if(typeof V.year=="undefined"){V.year=new Date().getFullYear()}if(typeof V.month=="undefined"){V.month=new Date().getMonth()+1}var R=new Date(V.year,V.month-1);if(typeof U.name!="undefined"){U.name=U.name.replace("YEAR",moment(R).format("YYYY"));U.name=U.name.replace("MONTH",moment(R).format("MMM"))}U.div=X;U.url="/api/"+U.key+"/";$.each(V,function(Y,Z){try{key_val=Y.split("__");U.qs=U.qs.replace(key_val[1].toUpperCase(),Z)}catch(aa){U.qs=U.qs.replace(Y.toUpperCase(),Z)}});if(typeof U.columns!="undefined"&&U.columns!=""){if(U.qs.length>0){U.qs+="&fields="+U.columns}else{U.qs+="?fields="+U.columns}}if(U.type=="data_table"){return B(V,U,X)}else{if(U.type=="data_table_sub"){return B(V,U,X)}else{if(U.type=="data_group_table"){return O(V,U,X)}else{if(U.type=="line_chart"){return m(V,U,X)}else{if(U.type=="chart_doubley"){F(V,U,X)}else{if(U.type=="bar_chart"){var W=new Date();W.setDate(1);W.setHours(-1);var S=V.year+"-"+V.month+"-"+W.getDate();U.qs=U.qs.replace("DATE",S);return p(V,U,X)}else{if(U.type=="line_bar_chart"){$("#data").data("linebar-div",X);if(U.window.key=="w11"){$("#"+X).append("<p>Please select a Holding above</p>");$("#data").data("linebar-div",X)}else{lineBarChart(U)}}else{if(U.type=="pie_chart"){return M(V,U,X)}else{if(U.type=="euro_percent_table"){return H(V,U,X)}}}}}}}}}}function m(U,V,R){if(typeof $("#"+R).highcharts()!="undefined"){}if(typeof V.params.type=="undefined"){var Y="line"}else{var Y=V.params.type}var Z=false;if(typeof V.params.title!="undefined"&&V.params.title=="true"){Z=V.name}var T=true;if(typeof V.params.yDecimals!="undefined"&&V.params.yDecimals==="false"){T=false}var S="Performance";if(typeof V.params.yAxisTitle!="undefined"){if(V.params.yAxisTitle=="false"){S=false}else{S=V.params.yAxisTitle}}var W=true;if(typeof V.params.labels!="undefined"&&V.params.labels=="false"){W=false}var ab=true;if(typeof V.params.legend!="undefined"&&V.params.legend=="false"){ab=false}var ac=false;if(typeof V.params.scrollbar!="undefined"&&V.params.scrollbar=="true"){ac=true}var aa=false;if(typeof V.params.navigator!="undefined"&&V.params.navigator=="true"){aa=true}var X=true;if(typeof V.params.rangeSelector!="undefined"&&V.params.rangeSelector=="false"){X=false}console.log(V.url+V.qs);$.getJSON(V.url+V.qs,function(af){console.log(af);var ad={chart:{type:Y,marginRight:25,size:"100%",renderTo:R,width:(120*V.size_x)+(10*V.size_x)+(10*(V.size_x-1))-10,height:(120*V.size_y)+(10*V.size_y)+(10*(V.size_y-1)),},navigator:{enabled:aa,adaptToUpdatedData:false,series:af.objects,height:20,},scrollbar:{enabled:ac},rangeSelector:{enabled:X,selected:4},title:{text:Z,},xAxis:{gridLineWidth:1,type:"category",categories:af.columns,},yAxis:{title:{text:S,},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{enabled:ab,},series:af.objects,};if(typeof V.params.date_type!="undefined"&&V.params.date_type=="month"){ad.rangeSelector={enabled:true,buttons:[{type:"year",count:1,text:"1y"},{type:"year",count:5,text:"5y"},{type:"year",count:10,text:"10y"},{type:"all",text:"All"}],inputEnabled:false,selected:1}}if(typeof V.params.zoom!="undefined"&&V.params.zoom=="true"){ad.xAxis={events:{afterSetExtremes:function(ag){zoomGraph(ag,V)}},minRange:3600*1000}}var ae=new Highcharts.StockChart(ad)})}function F(T,S,U){if(typeof S.params.type=="undefined"){var R="line"}else{var R=S.params.type}$.getJSON(S.url+S.qs,function(W){var V=new Highcharts.StockChart({chart:{type:R,renderTo:U,width:(120*S.size_x)+(10*S.size_x)+(10*(S.size_x-1))-50,height:(120*S.size_y)+(10*S.size_y)+(10*(S.size_y-1))-100,},navigator:{enabled:true,},scrollbar:{enabled:false},rangeSelector:{},title:{text:false},yAxis:[{},{opposite:true}],series:W})})}function p(S,R,T){$.getJSON(R.url+R.qs,function(Z){var aa=false;if(typeof R.params.title!="undefined"&&R.params.title=="true"){aa=R.name}var X="column";if(typeof R.params.type!="undefined"){X=R.params.type}var Y=true;if(typeof R.params.yDecimals!="undefined"&&R.params.yDecimals==="false"){Y=false}var W=true;if(typeof R.params.legend!="undefined"&&R.params.legend=="false"){W=false}var ab=false;if(typeof R.params.scrollbar!="undefined"&&R.params.scrollbar=="true"){ab=true}var U={chart:{renderTo:T,type:X,width:(120*R.size_x)+(10*R.size_x)+(10*(R.size_x-1))-30,height:(120*R.size_y)+(10*R.size_y)+(10*(R.size_y-1))-35,},title:{text:false},subtitle:{text:false},yAxis:{title:{text:false,},allowDecimals:Y,},legend:{enabled:W,},exporting:{enabled:true},xAxis:{type:"category",categories:Z.columns,},series:Z.objects,};if(typeof R.params.labels!="undefined"&&R.params.labels=="rotated"){labels={rotation:-45,align:"right",style:{fontSize:"10px",fontFamily:"Verdana, sans-serif"}};U.xAxis.labels=labels}console.log(R.window.key);if(R.window.key=="w2"||R.window.key=="w52"){$.getJSON("/api/fund/"+$("#data").data("fund")+"/?fields=mtd",function(ad){U.yAxis.plotLines=[{value:ad.mtd,width:1,color:"black",label:{text:$("#data").data("fund_name")+" Performance",},zIndex:5,}];var ac=new Highcharts.Chart(U)})}else{var V=new Highcharts.Chart(U)}$("#data").data("barchart-"+R.window.key,T)})}function A(S,T){var R=$("#data").data("fund");$('<div id="calendar"></div>').appendTo("body");mo_widget={};mo_widget.url="/api/fund-history/";mo_widget.qs="?fund="+R+"&fields=value_date,performance&order_by=value_date&value_date__year="+S+"&value_date__month="+T;$.getJSON(mo_widget.url+mo_widget.qs,function(X){var ab=new Date(S,T-1,1);var V=ab.getDay();var U=new Date(S,T,0);var Y=U.getDate();var Z='<table class="month_table"><tr>';if(V<6){for(i=1;i<V;i++){Z+="<td></td>"}}days={};for(i=0;i<X.length;i++){var ac=X[i].date.substr(8,2);ac=parseInt(ac,10);days[ac]=X[i].value}for(i=1;i<=Y;i++){if(typeof days[i]!="undefined"){var W=days[i]}else{var W=0}date=S.toString()+"-"+T.toString()+"-"+i;var ab=new Date(date);if(ab.getDay()==6||ab.getDay()==0){if(ab.getDay()==0&&i==1){continue}else{if(ab.getDay()==6&&i==1){i++;continue}else{Z+="</tr><tr>";i++;continue}}}Z+="<td>"+i+"<a href=\"#\" onclick=\"refreshHoldPerfBar('w2', '"+date+"', "+R+');">'+W+"</a></td>"}Z+="</tr></table>";var aa=new Ext.Window({renderTo:Ext.getBody(),html:Z,height:300,width:400,});aa.show();return;Ext.create("Ext.container.Container",{id:"month-table",width:400,renderTo:div,items:[{id:"month-table-content",xtype:"container",html:Z,}]})})}function g(T,S,U){fund=$("#data").data("fund");fields=[];for(i=0;i<S.columns.length;i++){fields[i]=S.columns[i].dataIndex}Ext.create("Ext.data.Store",{storeId:T.key,fields:fields,data:S,proxy:{type:"memory",reader:{type:"json",root:"rows"}},});plugins=[];selModel=[];if(T.window.key=="w10"&&$("#data").data("classification")=="eof"){plugins=[{ptype:"rowexpander",rowBodyTpl:['<div id="innergrid-'+T.id+'-{id}">',"</div>"]}];selModel={selType:"cellmodel"}}var R=Ext.create("Ext.grid.Panel",{title:T.params.title,store:Ext.data.StoreManager.lookup(T.key),columns:S.columns,height:(120*T.size_y)+(10*T.size_y)+(10*(T.size_y-1))-20,width:(120*T.size_x)+(10*T.size_x)+(10*(T.size_x-1))-20,layout:{type:"vbox",align:"stretch"},plugins:plugins,selModel:selModel,forceFit:true,layout:"fit",listeners:{cellclick:function(V,W,aa,Z){year=obj.page=$("#data").data("year");month=aa;if(month!=0){if(typeof year=="undefined"||year===false){year=new Date().getFullYear()}obj.page=$("#data").data("page_id");obj.grid=$("#data").data("grid"+obj.page);extra_params={year:year,};obj.year=year;obj.month=month;if(T.window.key=="w8"||T.window.key=="w66"){var ac="sec";var X="Sector"}else{if(T.window.key=="w9"){var ac="sub";var X="Sub-Sector"}else{if(T.window.key=="w10"||T.window.key=="w67"){var ac="loc";var X="Location"}}}U=$("#data").data("piechart-div-"+T.window.key);var ad="page_"+obj.page+"_win_"+T.window.id;var Y="&value_date__year=YEAR&value_date__month="+month+"&value_date__day=1";T.key="holding-breakdown";T.qs="?fund="+fund+"&category__group="+ac+"&y1=nav&data_type=graph&date=value_date&title=category__name"+Y;T.name="NAV by "+X+" MONTH YEAR";T.params.value_date__year=year;T.params.holding_category__holding_group="sec";T.params.fund="FUND";T.params.fields="nav";T.type="pie_chart";var ab=$("#"+U).highcharts();ab.destroy();L(obj,T,U,extra_params)}}}});if(T.window.key=="w10"&&$("#data").data("classification")=="eof"){R.view.on("expandBody",function(Y,W,V,X){if(typeof $("#data").data("year")=="undefined"||$("#data").data("year")=="false"){year=new Date().getFullYear()}else{year=$("#data").data("year")}var Z=W.get("id");$.getJSON("/api/country-breakdown/?fund="+fund+"&holding_category="+Z+"&value_date__year="+year+"&date=value_date&name=country__name&value=mtd&fields=value_date,country__name,mtd,si,ytd",function(aa){displayInnerGrid(T,aa,Z)});if(typeof $("#data").data("last-open-subgrid")!="undefined"){}});R.view.on("collapsebody",function(Y,W,V,X){destroyInnerGrid(W,T.id)})}return R}function H(S,R,T){fund=$("#data").data("fund");$.getJSON(R.url+R.qs,function(X){var W=T+"_"+T;$('<div id="'+W+'"></div>').appendTo("#"+T);if(typeof Ext.getCmp(T)!="undefined"){Y=Ext.getCmp(T);Y.destroy()}var Y=Ext.create("Ext.tab.Panel",{renderTo:W,id:W,});R.params.title="â‚¬";var V=g(R,X);Y.add(V);Y.doLayout();var U=R.qs.replace("fields=nav","fields=weight");R.params.title="% of Fund";$.getJSON(R.url+U,function(aa){var Z=g(R,aa);Y.add(Z);Y.doLayout()})})}function O(S,R,T){$.getJSON(R.url+R.qs,function(X){var V=$("#data").data("fund");fields=[];c=0;for(i=0;i<X.columns.length;i++){if(typeof X.columns[i].columns!="undefined"){for(x=0;x<X.columns[i].columns.length;x++){fields[c]=X.columns[i].columns[x].dataIndex;c++}}else{if(typeof X.columns[i].dataIndex!="undefined"){fields[c]=X.columns[i].dataIndex;c++}}}fields.push("group");var U=Ext.create("Ext.data.Store",{storeId:"groupStore",fields:fields,groupField:"group",data:X,proxy:{type:"memory",reader:{type:"json",root:"rows"}}});var W=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:"{name}",collapsible:false,depthToIndent:100,enableGroupingMenu:false,});return Ext.create("Ext.grid.Panel",{columnLines:true,cls:"custom-grid-group",store:Ext.data.StoreManager.lookup("groupStore"),columns:X.columns,features:[W],renderTo:T,width:(120*R.size_x)+(10*R.size_x)+(10*(R.size_x-1)),height:(120*R.size_y)+(10*R.size_y)+(10*(R.size_y-1)),forceFit:true,layout:"fit",})})}function a(V,U){var S=$("#data").data("fund");fields=[];c=0;for(i=0;i<V.columns.length;i++){if(typeof V.columns[i].columns!="undefined"){for(x=0;x<V.columns[i].columns.length;x++){fields[c]=V.columns[i].columns[x].dataIndex;c++}}else{if(typeof V.columns[i].dataIndex!="undefined"){fields[c]=V.columns[i].dataIndex;c++}}}fields.push("group");var R=Ext.create("Ext.data.Store",{storeId:"groupStore",fields:fields,groupField:"group",data:V,proxy:{type:"memory",reader:{type:"json",root:"rows"}}});var T=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:"{name}"});return Ext.create("Ext.grid.Panel",{columnLines:true,store:Ext.data.StoreManager.lookup("groupStore"),columns:V.columns,features:[T],width:(120*U.size_x)+(10*U.size_x)+(10*(U.size_x-1)),height:(120*U.size_y)+(10*U.size_y)+(10*(U.size_y-1)),forceFit:true,layout:"fit",})}function B(T,S,U){var R=false;if(typeof S.params.column_header!=="undefined"&&S.params.column_header=="false"){R=true}$.getJSON(S.url+S.qs,function(Y){fields=[];for(i=0;i<Y.columns.length;i++){if(typeof Y.columns[i].columns!="undefined"){for(x=0;x<Y.columns[i].columns.length;x++){arr={};row=Y.columns[i].columns[x].dataIndex;if(row.indexOf("name")!=-1){arr.type="string"}else{arr.type="float"}arr.name=row;fields.push(arr)}}else{row=Y.columns[i].dataIndex;if(typeof row!="undefined"){arr={};if(row.indexOf("name")!=-1||row.indexOf("Matrix")!=-1||row.indexOf("best_worst")!=-1){arr.type="string"}else{arr.type="float"}arr.name=row;fields.push(arr)}}}if(typeof Y.columns[1]["summaryType"]!="undefined"){Y.columns[0]["summaryRenderer"]=function(Z,ab,aa){return"Total"}}$.each(Y.rows,function(Z,aa){$.each(aa,function(ab,ac){if(ac.toString().indexOf(".")!=-1){Y.rows[Z][ab]=parseFloat(ac.toString())}})});console.log("fields:");console.log(fields);Ext.create("Ext.data.Store",{storeId:S.key,fields:fields,data:Y.rows,proxy:{type:"memory",reader:{type:"json",root:"rows"}},sortInfo:{direction:"DESC",field:"year"},});if(S.type=="data_table_sub"){cls="custom-grid-sub"}else{cls="custom-grid"}var X=(120*S.size_x)+(10*S.size_x)+(10*(S.size_x-1));var V=(120*S.size_y)+(10*S.size_y)+(10*(S.size_y-1));plugins=[{ptype:"rowexpander",rowBodyTpl:['<div id="innergrid-'+S.id+'-{id}">',"</div>"]}];selModel={selType:"cellmodel"};X=X-23;if(S.window.key=="w11"){for(i=0;i<Y.columns.length;i++){if(Y.columns[i].dataIndex=="name"){Y.columns[i].renderer=function(ad,aa,Z,af,ac,ab,ae){return'<a href="javascript:holdingTab('+Z.internalId+",  '"+ad+"');\">"+ad+"</a>"}}}}var W=Ext.create("Ext.grid.Panel",{id:U,cls:cls,columnLines:true,hideHeaders:R,store:Ext.data.StoreManager.lookup(S.key),columns:Y.columns,width:X,height:V,header:false,border:false,autoScroll:true,renderTo:U,plugins:plugins,selModel:selModel,iconCls:"icon-grid",forceFit:true,layout:"fit",features:[{ftype:"summary"}],listeners:{cellclick:function(ae,ac,aa,Z){year=Z.data.year;T.page=$("#data").data("page_id");T.grid=$("#data").data("grid"+T.page);extra_params={year:year,};T.year=year;T.month=1;month=aa-1;if(S.window.key=="w1"){if(aa==1){if($("#data").data("classification")==9){f("w3",T,extra_params);f("w4d",T,extra_params);f("w5",T,extra_params)}else{if($("#data").data("classification")==4){f("w3",T,extra_params);f("w4b",T,extra_params);f("w5b",T,extra_params)}else{if($("#data").data("classification")==10){f("w3",T,extra_params);f("w5",T,extra_params);f("w31",T,extra_params)}else{if($("#data").data("classification")==8){f("w3b",T,extra_params);f("w4b",T,extra_params);f("w5",T,extra_params)}else{if($("#data").data("classification")==2){f("w3",T,extra_params);f("w4b",T,extra_params);f("w5",T,extra_params)}else{if($("#data").data("classification")==1){f("w3",T,extra_params);f("w4",T,extra_params);f("w5",T,extra_params)}}}}}}}else{if(aa<14){refreshHoldPerfBar("w2",year+"-"+month+"-1",T.fund,true)}}}else{if(S.window.key=="w1b"){if(aa==1){if($("#data").data("classification")==3){f("w3",T,extra_params);f("w4b",T,extra_params);f("w5",T,extra_params)}else{if($("#data").data("classification")==5){f("w3",T,extra_params);f("w4",T,extra_params);f("w5",T,extra_params)}}}else{if(aa<14){refreshHoldPerfBar("w2",year+"-"+month+"-1",T.fund,true);A(year,month)}}}}if(S.window.key=="w6"){if(aa==1){$("#data").data("year",year);if($("#data").data("classification")==9){f("w9c",T,extra_params);f("w26",T,extra_params);f("w27",T,extra_params)}else{if($("#data").data("classification")==4){f("w8",T,extra_params);f("w4b",T,extra_params);f("w10b",T,extra_params)}else{if($("#data").data("classification")==10){f("w8",T,extra_params);f("w10",T,extra_params);f("w31",T,extra_params)}else{if($("#data").data("classification")==8){f("w8b",T,extra_params);f("w9b",T,extra_params);f("w10",T,extra_params)}else{if($("#data").data("classification")==2){f("w8",T,extra_params);f("w9b",T,extra_params);f("w10",T,extra_params)}else{if($("#data").data("classification")==1){f("w8",T,extra_params);f("w9",T,extra_params);f("w10",T,extra_params)}}}}}}}else{if(aa<13){refreshHoldPerfBar("w7",year+"-"+month+"-1",T.fund,true,"performance","weight")}}}else{if(S.window.key=="w6b"){if(aa==1){if($("#data").data("classification")==3){f("w8",T,extra_params);f("w9b",T,extra_params);f("w10b",T,extra_params)}else{if($("#data").data("classification")==5){f("w8",T,extra_params);f("w9",T,extra_params);f("w10",T,extra_params)}}}else{if(aa<14){refreshHoldPerfBar("w7",year+"-"+month+"-1",T.fund,true);A(year,month)}}}else{if(S.window.key=="w44"){if(aa==1){f("w8",T,extra_params)}else{if(aa<14){refreshHoldPerfBar("w45",year+"-"+month+"-1",T.client,true)}}}else{if(S.window.key=="w32"){if(aa==1){f("w34",T,extra_params)}else{if(aa<14){refreshHoldPerfBar("w33",year+"-"+month+"-1",T.client,true)}}}else{if(S.window.key=="w51"){if(aa==1){f("w53",T,extra_params);f("w54",T,extra_params);var ab="page_"+T.page+"_82";$("#data").data("date",new Date(year));investmentNAV(ab,"fund");var ad="Alpheus / YEAR / Alpheus Performance by Fund";ad=ad.replace("YEAR",moment(new Date(year)).format("YYYY"));E=Ext.getCmp("page_14_win_82");E.setTitle(ad)}else{if(aa<14){refreshHoldPerfBar("w52",year+"-"+month+"-1",T.fund,true)}}}else{if(S.window.key=="w64"){if(aa==1){f("w67",T,extra_params);f("w66",T,extra_params)}else{if(aa<14){refreshHoldPerfBar("w65",year+"-"+month+"-1",T.fund,true)}}}}}}}}}}});W.view.on("expandBody",function(ad,ab,aa,ac){var ae=ab.get("id");if(S.window.key=="w11"){var Z="trade_date,settlement_date,no_of_units,purchase_price_base,fx_euro,purchase_price,nav_purchase";$.getJSON("/api/trade/?holding="+ae+"&column_width=150,80&fields="+Z,function(af){displayInnerGrid(S,af,ae);S.holding=ab.get("id");S.fund=T.fund;lineBarChart(S)})}else{if(S.window.key=="w12"||S.window.key=="w12b"){var Z="&fields=first_name,last_name,no_of_units,nav,pending_nav";$.getJSON("/api/client/?&fund="+T.fund+"&client="+ae+"&column_width=100,100"+Z,function(af){displayInnerGrid(S,af,ae)})}}if(typeof $("#data").data("year")=="undefined"||$("#data").data("year")===false){year=new Date().getFullYear()}else{year=$("#data").data("year")}fund=$("#data").data("fund");if(S.window.key=="w5b"){$.getJSON("/api/country-breakdown/?fund="+fund+"&holding_category="+ae+"&value_date__year="+year+"&date=value_date&name=country__name&value=mtd&fields=id,value_date,country__name,mtd,si,ytd&column_width=80,50",function(af){displayInnerGrid(S,af,ae,true,50)})}if(S.window.key=="w31"){$.getJSON("/api/holding-history/?holding="+ae+"&value_date__year="+year+"&date_type=m&fields=value_date,drawdown,various,distribution,expense,valuation,total_value&total=true&column_width=80,50",function(af){displayInnerGrid(S,af,ae,false,150)})}if(S.window.key=="w12b"){$.getJSON("/api/holding/?client="+ae+"&distinct=true&total=true&fields=name,currency__name,commit,drawdown,various,residual_commit,distribution,valuation,total_value,proceed,irr",function(af){displayInnerGrid(S,af,ae,false,150)})}if(typeof $("#data").data("last-open-subgrid")!="undefined"){}});W.view.on("collapsebody",function(ac,aa,Z,ab){destroyInnerGrid(aa,S.id)});return W})}function f(S,T,R){$.getJSON("/api/widgets/?window__key="+S,function(U){for(x=0;x<U.length;x++){var Y="page_"+T.page+"_win_"+U[x].window.id;var V=Y+"_widget_"+U[x].id;var Z=U[x].window.name;year=R.year;week=1;Z=Z.replace("FUND_NAME",$("#data").data("fund_name"));Z=Z.replace("YEAR",year);Z=Z.replace("WEEK",week);E=Ext.getCmp(Y);if(typeof E!="undefined"){E.setTitle(Z)}else{console.log(Y)}if(U[x].type=="data_table"){var W=Ext.getCmp(V)}else{var W=$("#"+V).highcharts()}try{W.destroy()}catch(X){}$('<div id="'+V+'"></div>').appendTo("#"+Y);L(T,U[x],V,R)}})}function h(S,R,T){$.getJSON(R.url+R.qs,function(U){fields=["id"];for(i=0;i<U.columns.length;i++){fields[i]=U.columns[i].dataIndex}var V=Ext.create("Ext.data.Store",{fields:fields,data:U.rows,proxy:{type:"memory",reader:{type:"json",root:"objects"}}});var W=Ext.create("Ext.grid.Panel",{store:V,columns:U.columns,columnLines:true,cls:"custom-grid",selModel:{selType:"cellmodel"},width:(140*R.size_x)+(10*R.size_x)+(10*(R.size_x-1)),height:(140*R.size_y)+(10*R.size_y)+(10*(R.size_y-1)),plugins:[{ptype:"rowexpander",rowBodyTpl:['<div id="innergrid-'+R.id+'-{id}">',"</div>"]}],header:false,border:0,iconCls:"icon-grid",renderTo:T,id:"subtable"+R.key,});W.view.on("expandBody",function(aa,Y,X,Z){var ab=Y.get("id");console.log("outcommented");if(typeof $("#data").data("last-open-subgrid")!="undefined"){}});panel.view.on("collapsebody",function(aa,Y,X,Z){destroyInnerGrid(Y,R.id)})})}function M(S,R,T){$("#data").data("piechart-div-"+R.window.key,T);if(R.key=="fundnavpie"){$("#data").data("linebar-div",T);$("#"+T).append("<p>Please click on a month</p>");return}$.getJSON(R.url+R.qs,function(V){var U=new Highcharts.Chart({chart:{renderTo:T,type:"pie",marginTop:0,marginLeft:30,marginRight:30,height:(120*2)+(10*2)+(10*(2-1)),width:(120*2)+(10*2)+(10*(2-1)),},title:{text:R.name,},series:V.objects})})}function s(R){setInterval(function(){try{var S=Ext.StoreMgr.lookup(R);S.reload()}catch(T){}},2000)}function u(){var S=new Array();window.oldSetInterval=window.setInterval;window.setInterval=function(U,T){S.push(oldSetInterval(U,T))};for(var R in S){window.clearInterval(R)}}Ext.QuickTips.init();function t(){var R=$("#data").data("page_id");$.ajax({type:"GET",url:"/api/widget/unused/?page="+R,success:function(S){var T=Ext.create("Ext.data.Store",{storeId:"widgets",fields:["name","widget_type"],groupField:"widget_type",autoLoad:true,proxy:{data:S,type:"memory",reader:{type:"json",}},});var V=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{name} ({rows.length} Item{[values.rows.length > 1 ? "s" : ""]})'});var U=Ext.create("Ext.grid.Panel",{iconCls:"icon-grid",frame:true,store:T,header:false,region:"west",width:"60%",bodyBorder:false,hideHeaders:true,features:[V],columns:[{text:"Widget",flex:1,dataIndex:"name",},{text:"Type",flex:1,dataIndex:"widget_type",hidden:true,}],listeners:{itemclick:function(Z,X){$.ajax({type:"GET",url:"/api/widget/info/"+X.data.id,success:function(ab){$("#data").data("widget",ab);html='<div class="widget_desc"><img src="'+STATIC_URL+"widget-images/"+ab.key+'.png"></img><h1>'+ab.name+"</h1>"+ab.description+"</div>";var ac=Ext.getCmp("widget_desc");ac.update(html)},dataType:"json",contentType:"application/json",error:function(ab){}});try{var Y=Ext.getCmp("add_widget_btn");Y.enable()}catch(aa){}}}});var W=Ext.create("Ext.window.Window",{title:"Layout Window",closable:true,title:"Add Widget",width:"50%",height:"50%",layout:"border",items:[U,{region:"center",autoScroll:true,id:"widget_desc",html:'<div class="widget_preview">&#60;Preview&#62;</div>',}],buttonAlign:"right",buttons:[{scope:this,text:"Cancel",iconCls:"icon-cancel",handler:function(){W.close()}},{scope:this,text:"Add",iconCls:"icon-ok",disabled:true,id:"add_widget_btn",handler:function(){data=$("#data").data("widget");page=$("#data").data("page_id");U={};U.widget=data.resource_uri;U.page="/api/page/"+page+"/";U.row=1;U.col=1;U.size_y=data.size_y;U.size_x=data.size_x;$.ajax({type:"POST",url:"/api/pagewindow/",data:JSON.stringify(U),dataType:"json",contentType:"application/json",success:function(Y){var Z='<div id="'+page+"_"+data.key+'" pagewindow="'+Y.id+'" class="layout_block"></div>';var X=$("#data").data("grid"+page);X.add_widget(Z,data.size_x,data.size_y,1,1);L(data,page);d("",data.key,page,data.name,data.size_x,data.size_y);W.close()},})}}],}).show()},error:function(S){}})}function j(R){var R=$.parseJSON(R);for(i=0;i<R.length;i++){data={col:R[i].col,row:R[i].row,};$.ajax({type:"PATCH",url:"/api/pagewindow/"+R[i].pagewindow+"/",data:JSON.stringify(data),dataType:"json",contentType:"application/json",error:function(S){},})}}function e(){return Ext.create("Ext.panel.Panel",{region:"center",id:"panel-home",contentEl:"menu",autoDestroy:true,autoScroll:true,defaults:{autoScroll:true},})}function b(){return Ext.create("Ext.tab.Panel",{region:"center",contentEl:"menu",id:"panel-tab",autoDestroy:true,autoScroll:true,layout:"fit"})}var q=new Ext.menu.Menu({items:[{text:"Resize Widget",id:"resize_widget",},{text:"Remove Widget",id:"remove_widget",}],defaults:{listeners:{click:function(S,R){if(S.id=="resize_widget"){}else{if(S.id=="remove_widget"){}}}}},});var r=Ext.create("Ext.menu.Menu",{items:[{text:"Change Theme",menu:{items:[{text:"Default",checked:true,group:"theme",id:"theme_default",checkHandler:k},{text:"BlueBay",checked:false,group:"theme",id:"theme_bluebay",checkHandler:k}]}},{text:"Re-order Panels",id:"enable_drag",},{text:"Lock Panels",id:"disable_drag",hidden:true,},{text:"Log out",id:"log_out",}],defaults:{listeners:{click:function(S,R){page=$("#data").data("page_id");if(S.id=="add_widget"){t()}else{if(S.id=="disable_drag"){$("#data").data("grid"+page).disable();Ext.getCmp("enable_drag").setVisible(true);Ext.getCmp("disable_drag").setVisible(false)}else{if(S.id=="enable_drag"){$("#data").data("grid"+page).enable();Ext.getCmp("disable_drag").setVisible(true);Ext.getCmp("enable_drag").setVisible(false)}else{if(S.id=="log_out"){o()}}}}}}},});function k(S,R){if(S.id==="theme_bluebay"){var T="extjs-themes/bluebay/css/bluebay.css"}else{if(S.id==="theme_default"){var T="extjs/resources/css/ext-all.css"}}Ext.util.CSS.swapStyleSheet("theme",STATIC_URL+T)}function C(R){$.ajax({type:"GET",url:"/api/"+R,success:function(S){$("#data").data(R,S)}})}function P(R){$.ajax({type:"GET",url:"/api/fund/"+R+"?fields=name,classification__id",success:function(S){$("#data").data("fund_name",S.name);$("#data").data("classification",S.classification__id);console.log(S)}})}function l(R){$.ajax({type:"GET",url:"/api/client/"+R+"?fields=first_name,last_name",success:function(S){$("#data").data("client_name",S.last_name+", "+S.first_name)}})}function y(){$.getJSON("/api/menu/",function(R){$.getJSON("/api/client/?fields=first_name,last_name&order_by=last_name",function(U){console.log(U);client_list=[{expanded:false,children:[],id:"client_cat1",name:"Clients A - E",},{expanded:false,children:[],id:"client_cat2",name:"Clients F - L",},{expanded:false,children:[],id:"client_cat3",name:"Clients M - R",},{expanded:false,children:[],id:"client_cat4",name:"Clients S - U",},{expanded:false,children:[],id:"client_cat5",name:"Clients V - Z",}];$.each(U.rows,function(ab,Z){var Y=Z.last_name.toLowerCase().charCodeAt(0);var ac={expanded:false,client:Z.id,id:("client"+Z.id).valueOf(),leaf:true,name:Z.last_name+", "+Z.first_name,page:10};if(Y<102){var aa=0}else{if(Y<109){var aa=1}else{if(Y<115){var aa=2}else{if(Y<122){var aa=3}else{var aa=4}}}}client_list[aa].children.push(ac)});$.each(R,function(Y,Z){if(Z.id==21){R[Y].children=client_list}});var X=Ext.define("tree",{extend:"Ext.data.Model",fields:[{name:"id",type:"int"},{name:"text",type:"string",mapping:"name"},{name:"page",type:"string"},]});var V=Ext.create("Ext.data.TreeStore",{model:X,proxy:{data:R,type:"memory",reader:{type:"json",}},});var T=Ext.create("Ext.tree.Panel",{id:"main-menu",store:V,rootVisible:false,preventHeader:true,border:false,autoScroll:true,useArrows:true,height:1000,listeners:{itemexpand:{fn:function(Y,Z){nodeId=Y.data.id}},itemclick:{fn:function(Z,Y,ad,aa,ac,ab){if(Y.isExpanded()){Y.collapse()}else{Y.expand()}if(typeof Y.raw.fund!="undefined"){$("#data").data("fund",Y.raw.fund);P(Y.raw.fund)}if(typeof Y.raw.client!="undefined"){$("#data").data("client",Y.raw.client);l(Y.raw.client)}if(Y.raw.page!==null){if(typeof Y.raw.page==="number"){Y.raw.page=Y.raw.page}else{if(typeof Y.raw.page==="object"){Y.raw.page=Y.raw.page.id}else{try{var af=Y.raw.page.toString()}catch(ae){var af=Y.raw.page}Y.raw.page=af.replace(/\D/g,"")}}}N(Y.raw)}}}});var W=Ext.create("Ext.panel.Panel",{id:"west",region:"west",collapsible:true,title:"Navigation",width:150,items:[T],tools:[{type:"gear",handler:function(ab,aa,Z,Y){r.showBy(aa,"tr-br?")}}],});var S=Ext.create("Ext.container.Viewport",{layout:"border",id:"viewport",items:[W,e()]});Ext.EventManager.onWindowResize(S.doLayout,S)})})}Ext.QuickTips.init();var z=new Ext.FormPanel({labelWidth:80,url:"/api/user/login/",frame:true,defaultType:"textfield",monitorValid:true,header:false,style:"padding:10px",headers:{"Content-Type":"application/json"},items:[{fieldLabel:"Username",name:"username",allowBlank:false},{fieldLabel:"Password",name:"password",inputType:"password",allowBlank:false}],buttons:[{text:"Login",formBind:true,handler:function(){z.getForm().submit({method:"POST",headers:{"Content-Type":"application/json","X-HTTP-Method-Override":"POST"},success:function(){E.close();C("fund");C("page");y();page=new Object();page.page=1;v(page)},failure:function(R,S){Ext.Msg.alert("Login failed!","Wrong user name or passsword");z.getForm().reset()}})}}],});var E=new Ext.Window({closeAction:"hide",id:"login-window",title:"Please Login",layout:"fit",width:300,height:150,closable:false,resizable:false,plain:true,border:false,items:[z]});$("#data").data("login-window",E);function o(){$.ajax({type:"GET",url:"/api/user/logout/",success:function(R){var S=$("#data").data("active-panel");Ext.getCmp("west").setVisible(false);Ext.getCmp(S).setVisible(false);$("#data").data("login-window").show()},failure:function(){Ext.Msg.alert("Logout failed!","You could not be logged out.")}})}function Q(R){return(/^(GET|HEAD|OPTIONS|TRACE)$/.test(R))}$.ajaxSetup({crossDomain:false,beforeSend:function(S,R){if(!Q(R.type)){S.setRequestHeader("X-CSRFToken",$.cookie("csrftoken"))}}});$.ajax({type:"GET",url:"/api/loggedin/",success:function(R){C("page");$('<div id="menu" class="gridster"></div>').appendTo("body");y();$('<div id="page1"></div>').appendTo("#menu");$("#data").data("active-panel","panel-home");page=new Object();page.page=1;v(page)},error:function(){$('<div id="menu" class="gridster"></div>').appendTo("body");$('<div id="page1"></div>').appendTo("#menu");$("#data").data("active-panel","panel-home");E.show()}})});
